import gtfs.models
import os
import config
import numpy as np
import stops
import shapes
from utils import *
from common.ot_utils import *
from common import ot_utils
try:
    import matplotlib.pyplot as plt
except ImportError:
    pass
import datetime
from redis_intf.client import (get_redis_pipeline, 
                               get_redis_client,
                               load_by_key, 
                               save_by_key)
import json
from stop_detector import DetectedStopTime
import cProfile
import redis_data

def do_cprofile(func):
    def profiled_func(*args, **kwargs):
        profile = cProfile.Profile()
        try:
            profile.enable()
            result = func(*args, **kwargs)
            profile.disable()
            return result
        finally:
            profile.print_stats()
    return profiled_func

try:
    from line_profiler import LineProfiler

    def do_profile(follow=[]):
        def inner(func):
            def profiled_func(*args, **kwargs):
                try:
                    profiler = LineProfiler()
                    profiler.add_function(func)
                    for f in follow:
                        profiler.add_function(f)
                    profiler.enable_by_count()
                    return func(*args, **kwargs)
                finally:
                    profiler.print_stats()
            return profiled_func
        return inner

except ImportError:
    def do_profile(follow=[]):
        "Helpful if you accidentally leave in production!"
        def inner(func):
            def nothing(*args, **kwargs):
                return func(*args, **kwargs)
            return nothing
        return inner

# None means we cannot find a reasonable trip list
# empty list means there are no trips that fit this tracker
#@do_profile(follow=[])
def get_matched_trips(tracker_id, detected_stop_times,\
                       relevant_service_ids, print_debug_info=True):
    if len(detected_stop_times) == 0:
        return None, None

    stop_ids = [x.stop_id for x in detected_stop_times]
    stop_ids_inds = [stops.all_stops.id_list.index(x) for x in stop_ids]
    # we multiply AND rows so that any 0 will invalidate the stop - all stops
    # need to agree that this is a legal stop
    possible_costops_inds = (costops[stop_ids_inds,:].sum(axis=0) == len(stop_ids_inds)).astype(int)
    possible_costops_inds = possible_costops_inds.ravel().nonzero()[0]
    possible_costops_ids = [stops.all_stops.id_list[x] for x in possible_costops_inds]
    impossible_costops_ids = [x for x in stops.all_stops if x not in possible_costops_ids]
    
    # this one is slow:
    trips = gtfs.models.Trip.objects.filter(service__in=relevant_service_ids)
    trip_stop_times = gtfs.models.StopTime.objects.filter(trip__in = trips, stop__in = stop_ids)
    trips_with_visited_stops = list(set(trip_stop_times.values_list('trip')))
    trips_with_visited_stops = [x[0] for x in trips_with_visited_stops]
    trips_with_visited_stops_stop_times = gtfs.models.StopTime.objects.filter(trip__in = trips_with_visited_stops)
    trips_with_impossible_stops = list(set(trips_with_visited_stops_stop_times.filter(stop__stop_id__in = impossible_costops_ids).values_list('trip')))
    trips_with_impossible_stops = [x[0] for x in trips_with_impossible_stops]
    trips_with_visited_stops_filtered_by_costops = list(set(trips_with_visited_stops) - set(trips_with_impossible_stops))
    
    # filter by stop existence and its time frame:
    trips_filtered_by_stops_and_times = trips_with_visited_stops_filtered_by_costops
    if print_debug_info:
        print "trips_with_visited_stops =", len(trips_with_visited_stops)
        print "trips_with_visited_stops_filtered_by_costops =", len(trips_with_visited_stops_filtered_by_costops)
    
    # filter by stop order and at least two detected stops:
    trip_in_right_direction = []
    for i, t in enumerate(trips_filtered_by_stops_and_times):
        detected_stop_ids = [x.stop_id for x in detected_stop_times]        
        trip_stop_times = gtfs.models.StopTime.objects.filter(trip = t, stop__stop_id__in=detected_stop_ids).values_list('stop', 'arrival_time')
        trip_stop_times_dict = dict(trip_stop_times)
        if len(trip_stop_times) >= 2:
            gtfs_arrival_of_detected_stops = [trip_stop_times_dict.get(x) for x in detected_stop_ids]
            gtfs_arrival_of_detected_stops = [x for x in gtfs_arrival_of_detected_stops if x is not None]
            #stop_inds_by_visit_order = [trip_stop_times.index(x) for x in detected_stop_ids]
            if is_increasing(gtfs_arrival_of_detected_stops):
                trip_in_right_direction.append(i)
    
    trips_filtered_by_stops_and_times = [trips_filtered_by_stops_and_times[i] for i in trip_in_right_direction]
    
    arrival_delta_abs_sums_seconds = []
    #departure_delta_abs_sums = []
    for t in trips_filtered_by_stops_and_times:
        stop_times_gtfs = gtfs.models.StopTime.objects.filter(trip = t).order_by('arrival_time').values_list('stop', 'arrival_time')#, 'departure_time')
        arrival_delta_abs_sum = 0
        #departure_delta_abs_sum = 0
        for detected_stop_time in detected_stop_times:
            stop_and_arrival_gtfs = [x for x in stop_times_gtfs if x[0] == detected_stop_time.stop_id]
            if stop_and_arrival_gtfs:
                arrival_delta_seconds = stop_and_arrival_gtfs[0][1] - datetime_to_db_time(detected_stop_time.arrival)
                #departure_delta_seconds = stop_time[2] - datetime_to_db_time(tracked_stop_time.departure)
                arrival_delta_abs_sum += abs(arrival_delta_seconds)
                #departure_delta_abs_sum += abs(departure_delta_seconds)
        arrival_delta_abs_sums_seconds.append(arrival_delta_abs_sum)
        #departure_delta_abs_sums.append(departure_delta_abs_sum)
    
    # sort results by increasing arrival time 
    sorted_trips = sorted(zip(arrival_delta_abs_sums_seconds,trips_filtered_by_stops_and_times))
    trips_filtered_by_stops_and_times = [x for (y,x) in sorted_trips]
    # trips_filtered_by_stops_and_times to trip_ids
    #trips_filtered_by_stops_and_times = [x.trip_id for x in trips_filtered_by_stops_and_times]
    arrival_delta_abs_sums_seconds = [y for (y,x) in sorted_trips]
    if print_debug_info:
        print "arrival_delta_abs_sums_seconds =", arrival_delta_abs_sums_seconds
    return trips_filtered_by_stops_and_times, arrival_delta_abs_sums_seconds

def get_matched_trips_old(tracker_id, detected_stop_times,\
                       relevant_service_ids, print_debug_info=False):
    if len(detected_stop_times) == 0:
        return None, None

    trips = gtfs.models.Trip.objects.filter(service__in=relevant_service_ids)

    # filter by stop existence and its time frame:
    trips_filtered_by_stops_and_times = trips
    if print_debug_info:
        print len(trips_filtered_by_stops_and_times)
    
    for stop_time in detected_stop_times:
        arrival = stop_time.arrival
        stop_id = stop_time.stop_id
        name = stops.all_stops[stop_id].name
        departure = stop_time.departure
        
        trip_stop_times = gtfs.models.StopTime.objects.filter(trip__in = trips_filtered_by_stops_and_times)
        arrival_time__greater_than = arrival-datetime.timedelta(seconds=config.late_arrival_max_seconds)
        arrival_time__less_than = arrival+datetime.timedelta(seconds=config.early_arrival_max_seconds)
        arrival_time__range = datetime_range_to_db_time(arrival_time__greater_than, arrival_time__less_than)

        if departure is not None:
            departure_time__greater_than = departure-datetime.timedelta(seconds=config.late_departure_max_seconds)
            departure_time__less_than = departure+datetime.timedelta(seconds=config.early_departure_max_seconds)
            departure_time__range = datetime_range_to_db_time(departure_time__greater_than, departure_time__less_than)
            trip_stop_times_for_specific_stop = trip_stop_times.filter(stop = stop_id, arrival_time__range=arrival_time__range, departure_time__range=departure_time__range)
        else:
            trip_stop_times_for_specific_stop = trip_stop_times.filter(stop = stop_id, 
                                                                       arrival_time__range=arrival_time__range)                
            
        trips_filtered_by_stops_and_times = trip_stop_times_for_specific_stop.values_list('trip')

        if print_debug_info:
            print len(trips_filtered_by_stops_and_times)
    
    # filter by stop order:
    trip_in_right_direction = []
    for i, t in enumerate(trips_filtered_by_stops_and_times):
        trip_stop_times = gtfs.models.StopTime.objects.filter(trip = t).order_by('arrival_time').values_list('stop')
        trip_stop_times = [x[0] for x in trip_stop_times]
        stop_inds_by_visit_order = [trip_stop_times.index(x) for x in [x.stop_id for x in detected_stop_times]]
        if is_increasing(stop_inds_by_visit_order):
            trip_in_right_direction.append(i)
    
    trips_filtered_by_stops_and_times = [trips_filtered_by_stops_and_times[i][0] for i in trip_in_right_direction]
    
    arrival_delta_abs_sums_seconds = []
    #departure_delta_abs_sums = []
    for t in trips_filtered_by_stops_and_times:
        stop_times_redis = gtfs.models.StopTime.objects.filter(trip = t).order_by('arrival_time').values_list('stop', 'arrival_time')#, 'departure_time')
        arrival_delta_abs_sum = 0
        #departure_delta_abs_sum = 0
        for detected_stop_time in detected_stop_times:
            stop_time = [x for x in stop_times_redis if x[0] == detected_stop_time.stop_id][0]
            arrival_delta_seconds = stop_time[1] - datetime_to_db_time(detected_stop_time.arrival)
            #departure_delta_seconds = stop_time[2] - datetime_to_db_time(tracked_stop_time.departure)
            arrival_delta_abs_sum += abs(arrival_delta_seconds)
            #departure_delta_abs_sum += abs(departure_delta_seconds)
        arrival_delta_abs_sums_seconds.append(arrival_delta_abs_sum)
        #departure_delta_abs_sums.append(departure_delta_abs_sum)
    
    # sort results by increasing arrival time 
    sorted_trips = sorted(zip(arrival_delta_abs_sums_seconds,trips_filtered_by_stops_and_times))
    trips_filtered_by_stops_and_times = [x for (y,x) in sorted_trips]
    arrival_delta_abs_sums_seconds = [y for (y,x) in sorted_trips]
    return trips_filtered_by_stops_and_times, arrival_delta_abs_sums_seconds



costops = redis_data.get_costop_matrix()
cl = get_redis_client()
p = get_redis_pipeline()